<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaZi Module Development Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .control-panel {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        .input-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }
        .input-group input, .input-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        button:hover {
            background: #1976D2;
        }
        button.secondary {
            background: #757575;
        }
        button.secondary:hover {
            background: #616161;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #d32f2f;
        }
        .output-section {
            margin-top: 20px;
        }
        .output-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
        }
        .tab:hover {
            background: #f5f5f5;
        }
        .tab.active {
            color: #2196F3;
            border-bottom: 2px solid #2196F3;
            margin-bottom: -2px;
        }
        .tab-content {
            display: none;
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
            min-height: 300px;
        }
        .tab-content.active {
            display: block;
        }
        .output-box {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .chinese-text {
            font-size: 24px;
            font-weight: bold;
            color: #d32f2f;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        th {
            background: #f5f5f5;
            font-weight: 600;
        }
        .success {
            color: #4CAF50;
        }
        .error {
            color: #f44336;
        }
        .warning {
            color: #ff9800;
        }
        .debug-panel {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .quick-tests {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background: #f5f5f5;
        }
        .test-result.pass {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
        }
        .test-result.fail {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BaZi Module Development & Testing</h1>
        
        <div class="control-panel">
            <h3>Test Configuration</h3>
            <div class="input-grid">
                <div class="input-group">
                    <label for="birth-date">Birth Date</label>
                    <input type="date" id="birth-date" value="1990-05-15">
                </div>
                <div class="input-group">
                    <label for="birth-time">Birth Time</label>
                    <input type="time" id="birth-time" value="14:30">
                </div>
                <div class="input-group">
                    <label for="gender">Gender</label>
                    <select id="gender">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="latitude">Latitude</label>
                    <input type="number" id="latitude" value="39.9042" step="0.0001">
                </div>
                <div class="input-group">
                    <label for="longitude">Longitude</label>
                    <input type="number" id="longitude" value="116.4074" step="0.0001">
                </div>
                <div class="input-group">
                    <label for="timezone">Timezone (hours)</label>
                    <input type="number" id="timezone" value="8" step="0.5">
                </div>
            </div>
            
            <div class="quick-tests">
                <button onclick="loadPreset('beijing')">Beijing Test</button>
                <button onclick="loadPreset('newyork')">New York Test</button>
                <button onclick="loadPreset('london')">London Test</button>
                <button onclick="loadPreset('lichun')">Lichun Test</button>
                <button onclick="loadPreset('midnight')">Midnight Test</button>
            </div>
            
            <div class="button-row">
                <button onclick="calculateFull()">Calculate Full Chart</button>
                <button onclick="testSpecificFunction('julian')" class="secondary">Test Julian Day</button>
                <button onclick="testSpecificFunction('solar')" class="secondary">Test Solar Time</button>
                <button onclick="testSpecificFunction('year')" class="secondary">Test Year Pillar</button>
                <button onclick="testSpecificFunction('month')" class="secondary">Test Month Pillar</button>
                <button onclick="testSpecificFunction('day')" class="secondary">Test Day Pillar</button>
                <button onclick="testSpecificFunction('hour')" class="secondary">Test Hour Pillar</button>
                <button onclick="testSpecificFunction('luck')" class="secondary">Test Luck Pillars</button>
                <button onclick="testSpecificFunction('interactions')" class="secondary">Test Interactions</button>
                <button onclick="runAllTests()">Run All Tests</button>
                <button onclick="clearAll()" class="danger">Clear All</button>
            </div>
        </div>
        
        <div class="output-section">
            <div class="output-tabs">
                <button class="tab active" onclick="switchTab('chart')">Chart Output</button>
                <button class="tab" onclick="switchTab('calculations')">Calculations</button>
                <button class="tab" onclick="switchTab('tests')">Test Results</button>
                <button class="tab" onclick="switchTab('debug')">Debug Log</button>
                <button class="tab" onclick="switchTab('constants')">Constants</button>
            </div>
            
            <div id="chart-tab" class="tab-content active">
                <div id="chart-output"></div>
            </div>
            
            <div id="calculations-tab" class="tab-content">
                <div id="calculations-output"></div>
            </div>
            
            <div id="tests-tab" class="tab-content">
                <div id="tests-output"></div>
            </div>
            
            <div id="debug-tab" class="tab-content">
                <div class="debug-panel" id="debug-output"></div>
            </div>
            
            <div id="constants-tab" class="tab-content">
                <div id="constants-output"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as BaZi from './bazi.js';
        
        // Make BaZi available globally for debugging
        window.BaZi = BaZi;
        
        // Presets for quick testing
        const presets = {
            beijing: {
                date: '1990-05-15',
                time: '14:30',
                latitude: 39.9042,
                longitude: 116.4074,
                timezone: 8,
                gender: 'male'
            },
            newyork: {
                date: '1990-05-15',
                time: '14:30',
                latitude: 40.7128,
                longitude: -74.0060,
                timezone: -5,
                gender: 'male'
            },
            london: {
                date: '1990-05-15',
                time: '14:30',
                latitude: 51.5074,
                longitude: -0.1278,
                timezone: 0,
                gender: 'male'
            },
            lichun: {
                date: '2000-02-04',
                time: '05:30',
                latitude: 39.9042,
                longitude: 116.4074,
                timezone: 8,
                gender: 'male'
            },
            midnight: {
                date: '1990-05-15',
                time: '23:30',
                latitude: 39.9042,
                longitude: 116.4074,
                timezone: 8,
                gender: 'male'
            }
        };
        
        // Global functions
        window.loadPreset = function(presetName) {
            const preset = presets[presetName];
            if (preset) {
                document.getElementById('birth-date').value = preset.date;
                document.getElementById('birth-time').value = preset.time;
                document.getElementById('latitude').value = preset.latitude;
                document.getElementById('longitude').value = preset.longitude;
                document.getElementById('timezone').value = preset.timezone;
                document.getElementById('gender').value = preset.gender;
                log(`Loaded preset: ${presetName}`);
            }
        };
        
        window.clearAll = function() {
            document.getElementById('chart-output').innerHTML = '';
            document.getElementById('calculations-output').innerHTML = '';
            document.getElementById('tests-output').innerHTML = '';
            document.getElementById('debug-output').innerHTML = '';
            log('Cleared all outputs');
        };
        
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        };
        
        // Logging function
        function log(message, type = 'info') {
            const debugOutput = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef5350' : type === 'success' ? '#66bb6a' : '#90caf9';
            debugOutput.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }
        
        // Get input values
        function getInputValues() {
            const date = document.getElementById('birth-date').value;
            const time = document.getElementById('birth-time').value;
            const birthDate = new Date(`${date}T${time}:00`);
            
            return {
                birthDate,
                location: {
                    latitude: parseFloat(document.getElementById('latitude').value),
                    longitude: parseFloat(document.getElementById('longitude').value),
                    timezone: parseFloat(document.getElementById('timezone').value)
                },
                gender: document.getElementById('gender').value
            };
        }
        
        // Calculate full chart
        window.calculateFull = function() {
            try {
                const { birthDate, location, gender } = getInputValues();
                log('Starting full chart calculation...');
                
                const chart = BaZi.calculateBaziChart(birthDate, location, gender);
                
                // Display chart
                displayChart(chart);
                
                // Display calculations
                displayCalculations(birthDate, location, chart);
                
                log('Chart calculation completed successfully', 'success');
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        // Display chart in formatted table
        function displayChart(chart) {
            const output = document.getElementById('chart-output');
            
            let html = '<h3>BaZi Chart</h3>';
            html += '<table>';
            html += '<tr><th>Pillar</th><th>Hour</th><th>Day</th><th>Month</th><th>Year</th></tr>';
            
            // Heavenly Stems
            html += '<tr><td>Heavenly Stem</td>';
            ['hourPillar', 'dayPillar', 'monthPillar', 'yearPillar'].forEach(pillar => {
                const stem = chart[pillar].stem;
                html += `<td>
                    <div class="chinese-text">${stem.chinese}</div>
                    <div>${stem.pinyin}</div>
                    <div>${stem.element}</div>
                </td>`;
            });
            html += '</tr>';
            
            // Earthly Branches
            html += '<tr><td>Earthly Branch</td>';
            ['hourPillar', 'dayPillar', 'monthPillar', 'yearPillar'].forEach(pillar => {
                const branch = chart[pillar].branch;
                html += `<td>
                    <div class="chinese-text">${branch.chinese}</div>
                    <div>${branch.pinyin}</div>
                    <div>${branch.animal}</div>
                    <div>${branch.element}</div>
                </td>`;
            });
            html += '</tr>';
            
            // Hidden Stems
            html += '<tr><td>Hidden Stems</td>';
            ['hourPillar', 'dayPillar', 'monthPillar', 'yearPillar'].forEach(pillar => {
                const hiddenStems = chart[pillar].branch.hiddenStems || [];
                html += '<td>';
                hiddenStems.forEach(stem => {
                    html += `<div>${stem.chinese} (${stem.element})</div>`;
                });
                html += '</td>';
            });
            html += '</tr>';
            
            html += '</table>';
            
            // Luck Pillars
            html += '<h3>Luck Pillars</h3>';
            html += '<table>';
            html += '<tr><th>Age</th><th>Stem</th><th>Branch</th><th>Period</th></tr>';
            
            chart.luckPillars.slice(0, 10).forEach(pillar => {
                html += `<tr>
                    <td>${pillar.startAge}-${pillar.endAge}</td>
                    <td class="chinese-text">${pillar.stem.chinese}<br>${pillar.stem.pinyin}<br>${pillar.stem.element}</td>
                    <td class="chinese-text">${pillar.branch.chinese}<br>${pillar.branch.pinyin}<br>${pillar.branch.animal}</td>
                    <td>${pillar.stem.element} ${pillar.branch.element}</td>
                </tr>`;
            });
            html += '</table>';
            
            // Interactions
            html += '<h3>Interactions</h3>';
            html += '<div class="output-box">';
            html += JSON.stringify(chart.interactions, null, 2);
            html += '</div>';
            
            output.innerHTML = html;
        }
        
        // Display calculation details
        function displayCalculations(birthDate, location, chart) {
            const output = document.getElementById('calculations-output');
            
            let html = '<h3>Calculation Details</h3>';
            
            // Julian Day
            html += '<h4>Julian Day Calculation</h4>';
            const jd = BaZi.calculateJulianDay(
                birthDate.getFullYear(),
                birthDate.getMonth() + 1,
                birthDate.getDate(),
                birthDate.getHours(),
                birthDate.getMinutes(),
                birthDate.getSeconds()
            );
            html += `<div class="output-box">Julian Day: ${jd.toFixed(5)}</div>`;
            
            // Solar Time
            html += '<h4>Solar Time Calculation</h4>';
            const solarTime = BaZi.calculateLocalSolarTime(birthDate, location.longitude, location.timezone * 60);
            html += `<div class="output-box">`;
            html += `Standard Time: ${birthDate.toLocaleString()}\n`;
            html += `Solar Time: ${solarTime.toLocaleString()}\n`;
            html += `Difference: ${((solarTime - birthDate) / (1000 * 60)).toFixed(2)} minutes`;
            html += `</div>`;
            
            // Year calculation details
            html += '<h4>Year Pillar Details</h4>';
            html += `<div class="output-box">`;
            html += `Calculated Year: ${chart.yearPillar.year}\n`;
            html += `Lichun Time: ${chart.yearPillar.lichunTime.toLocaleString()}\n`;
            html += `Birth Time: ${birthDate.toLocaleString()}\n`;
            html += `Before Lichun: ${birthDate < chart.yearPillar.lichunTime}`;
            html += `</div>`;
            
            // Month calculation details
            html += '<h4>Month Pillar Details</h4>';
            html += `<div class="output-box">`;
            html += `Solar Term: ${chart.monthPillar.solarTerm}\n`;
            html += `Month Number: ${chart.monthPillar.month}`;
            html += `</div>`;
            
            output.innerHTML = html;
        }
        
        // Test specific functions
        window.testSpecificFunction = function(functionName) {
            const output = document.getElementById('tests-output');
            let html = '';
            
            try {
                switch (functionName) {
                    case 'julian':
                        html = testJulianDay();
                        break;
                    case 'solar':
                        html = testSolarTime();
                        break;
                    case 'year':
                        html = testYearPillar();
                        break;
                    case 'month':
                        html = testMonthPillar();
                        break;
                    case 'day':
                        html = testDayPillar();
                        break;
                    case 'hour':
                        html = testHourPillar();
                        break;
                    case 'luck':
                        html = testLuckPillars();
                        break;
                    case 'interactions':
                        html = testInteractions();
                        break;
                    default:
                        html = 'Unknown test function';
                }
                
                output.innerHTML = html;
                log(`Completed test: ${functionName}`, 'success');
            } catch (error) {
                output.innerHTML = `<div class="error">Error in ${functionName}: ${error.message}</div>`;
                log(`Test failed: ${functionName} - ${error.message}`, 'error');
            }
        };
        
        // Individual test functions
        function testJulianDay() {
            let html = '<h3>Julian Day Test</h3>';
            
            const tests = [
                { date: new Date('2000-01-01T12:00:00'), expected: 2451545.0 },
                { date: new Date('1900-01-01T12:00:00'), expected: 2415021.0 },
                { date: new Date('2024-05-13T00:00:00'), expected: 2460444.5 }
            ];
            
            tests.forEach(test => {
                const jd = BaZi.calculateJulianDay(
                    test.date.getFullYear(),
                    test.date.getMonth() + 1,
                    test.date.getDate(),
                    test.date.getHours(),
                    test.date.getMinutes(),
                    test.date.getSeconds()
                );
                
                const diff = Math.abs(jd - test.expected);
                const pass = diff < 1.0;
                
                html += `<div class="test-result ${pass ? 'pass' : 'fail'}">`;
                html += `Date: ${test.date.toISOString()}<br>`;
                html += `Calculated: ${jd.toFixed(5)}<br>`;
                html += `Expected: ${test.expected}<br>`;
                html += `Difference: ${diff.toFixed(5)}<br>`;
                html += `Result: ${pass ? 'PASS' : 'FAIL'}`;
                html += `</div>`;
            });
            
            return html;
        }
        
        function testSolarTime() {
            let html = '<h3>Solar Time Test</h3>';
            const { birthDate, location } = getInputValues();
            
            const solarTime = BaZi.calculateLocalSolarTime(birthDate, location.longitude, location.timezone * 60);
            const diff = (solarTime - birthDate) / (1000 * 60);
            
            html += `<div class="test-result pass">`;
            html += `Standard Time: ${birthDate.toLocaleString()}<br>`;
            html += `Solar Time: ${solarTime.toLocaleString()}<br>`;
            html += `Longitude: ${location.longitude}°<br>`;
            html += `Timezone: UTC${location.timezone >= 0 ? '+' : ''}${location.timezone}<br>`;
            html += `Time Difference: ${diff.toFixed(2)} minutes`;
            html += `</div>`;
            
            return html;
        }
        
        function testYearPillar() {
            let html = '<h3>Year Pillar Test</h3>';
            const { birthDate, location } = getInputValues();
            
            const yearPillar = BaZi.calculateYearPillar(birthDate, location);
            
            html += `<div class="test-result pass">`;
            html += `Birth Date: ${birthDate.toLocaleDateString()}<br>`;
            html += `Calculated Year: ${yearPillar.year}<br>`;
            html += `Stem: ${yearPillar.stem.chinese} (${yearPillar.stem.pinyin}) - ${yearPillar.stem.element}<br>`;
            html += `Branch: ${yearPillar.branch.chinese} (${yearPillar.branch.pinyin}) - ${yearPillar.branch.animal}<br>`;
            html += `Lichun: ${yearPillar.lichunTime.toLocaleString()}`;
            html += `</div>`;
            
            return html;
        }
        
        function testMonthPillar() {
            let html = '<h3>Month Pillar Test</h3>';
            const { birthDate, location } = getInputValues();
            
            const yearPillar = BaZi.calculateYearPillar(birthDate, location);
            const monthPillar = BaZi.calculateMonthPillar(birthDate, yearPillar, location);
            
            html += `<div class="test-result pass">`;
            html += `Birth Date: ${birthDate.toLocaleDateString()}<br>`;
            html += `Solar Term: ${monthPillar.solarTerm}<br>`;
            html += `Month Number: ${monthPillar.month}<br>`;
            html += `Stem: ${monthPillar.stem.chinese} (${monthPillar.stem.pinyin}) - ${monthPillar.stem.element}<br>`;
            html += `Branch: ${monthPillar.branch.chinese} (${monthPillar.branch.pinyin}) - ${monthPillar.branch.animal}`;
            html += `</div>`;
            
            return html;
        }
        
        function testDayPillar() {
            let html = '<h3>Day Pillar Test</h3>';
            const { birthDate, location } = getInputValues();
            
            const dayPillar = BaZi.calculateDayPillar(birthDate, location);
            
            html += `<div class="test-result pass">`;
            html += `Birth Date: ${birthDate.toLocaleDateString()}<br>`;
            html += `Julian Day: ${dayPillar.julianDay.toFixed(5)}<br>`;
            html += `Stem: ${dayPillar.stem.chinese} (${dayPillar.stem.pinyin}) - ${dayPillar.stem.element}<br>`;
            html += `Branch: ${dayPillar.branch.chinese} (${dayPillar.branch.pinyin}) - ${dayPillar.branch.animal}`;
            html += `</div>`;
            
            return html;
        }
        
        function testHourPillar() {
            let html = '<h3>Hour Pillar Test</h3>';
            const { birthDate, location } = getInputValues();
            
            const dayPillar = BaZi.calculateDayPillar(birthDate, location);
            const hourPillar = BaZi.calculateHourPillar(birthDate, dayPillar, location);
            
            html += `<div class="test-result pass">`;
            html += `Birth Time: ${birthDate.toLocaleTimeString()}<br>`;
            html += `Hour: ${hourPillar.hour}:${hourPillar.minute}<br>`;
            html += `Stem: ${hourPillar.stem.chinese} (${hourPillar.stem.pinyin}) - ${hourPillar.stem.element}<br>`;
            html += `Branch: ${hourPillar.branch.chinese} (${hourPillar.branch.pinyin}) - ${hourPillar.branch.animal}<br>`;
            html += `Hour Range: ${hourPillar.branch.hourRange[0]}:00 - ${hourPillar.branch.hourRange[1]}:00`;
            html += `</div>`;
            
            return html;
        }
        
        function testLuckPillars() {
            let html = '<h3>Luck Pillars Test</h3>';
            const { birthDate, location, gender } = getInputValues();
            
            const chart = BaZi.calculateBaziChart(birthDate, location, gender);
            
            html += `<div class="test-result pass">`;
            html += `Gender: ${gender}<br>`;
            html += `Year Stem: ${chart.yearPillar.stem.element} (${chart.yearPillar.stem.number % 2 === 1 ? 'Yang' : 'Yin'})<br><br>`;
            
            chart.luckPillars.slice(0, 5).forEach((pillar, index) => {
                html += `Luck Pillar ${index + 1}:<br>`;
                html += `Age: ${pillar.startAge}-${pillar.endAge}<br>`;
                html += `${pillar.stem.chinese}${pillar.branch.chinese} (${pillar.stem.element} ${pillar.branch.animal})<br><br>`;
            });
            html += `</div>`;
            
            return html;
        }
        
        function testInteractions() {
            let html = '<h3>Interactions Test</h3>';
            const { birthDate, location, gender } = getInputValues();
            
            const chart = BaZi.calculateBaziChart(birthDate, location, gender);
            const interactions = chart.interactions;
            
            html += `<div class="test-result pass">`;
            html += `Combinations: ${interactions.combinations.length}<br>`;
            html += `Three Harmonies: ${interactions.threeHarmonies.length}<br>`;
            html += `Clashes: ${interactions.clashes.length}<br>`;
            html += `Harms: ${interactions.harms.length}<br>`;
            html += `Penalties: ${interactions.penalties.length}<br>`;
            html += `Destructions: ${interactions.destructions.length}<br><br>`;
            
            if (interactions.combinations.length > 0) {
                html += '<strong>Combinations:</strong><br>';
                interactions.combinations.forEach(combo => {
                    html += `${combo.branches.join(' + ')} → ${combo.result}<br>`;
                });
            }
            
            if (interactions.clashes.length > 0) {
                html += '<br><strong>Clashes:</strong><br>';
                interactions.clashes.forEach(clash => {
                    html += `${clash.branches.join(' ↔ ')}<br>`;
                });
            }
            
            html += `</div>`;
            
            return html;
        }
        
        // Run all tests
        window.runAllTests = function()
