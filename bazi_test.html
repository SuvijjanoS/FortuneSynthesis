<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaZi Module Test (Consolidated)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1, h2 {
            color: #0056b3;
        }
        pre {
            background-color: #eee;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap; /* Ensure text wraps */
            word-wrap: break-word; /* Break long words */
        }
        .result-box {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fff;
            border-radius: 8px;
        }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>BaZi Module Isolated Test (Consolidated)</h1>
    <p>This page runs a test case for the BaZi calculation module with all code and mock data in one file.</p>
    <div id="results"></div>

    <script type="text/javascript">
        // --- CONSOLIDATED JAVASCRIPT CODE ---

        // -----------------------------------------------------------------------------
        // MOCK Swiss Ephemeris (swe) object for browser testing
        // This is a simplified Julian Day calculation and won't be as precise as actual Swiss Ephemeris.
        // From original bazi.js
        // -----------------------------------------------------------------------------
        let swe = {
          julday: (year, month, day, hour, minute, second) => {
            // Simple Julian Day calculation without Swiss Ephemeris
            let a = Math.floor((14 - month) / 12);
            let y = year + 4800 - a;
            let m = month + 12 * a - 3;
            return day + Math.floor((153 * m + 2) / 5) + 365 * y + Math.floor(y / 4) - 
                   Math.floor(y / 100) + Math.floor(y / 400) - 32045 + (hour - 12) / 24;
          },
          calcUt: () => 0, // Mocked for simplicity
          revjul: () => {}, // Mocked
          sweClose: () => {}, // Mocked
          Module: {
            ccall: () => {}
          }
        };

        // -----------------------------------------------------------------------------
        // MOCK WanNianLi data for browser testing
        // This is a small subset; real application would load the full JSON.
        // From original bazi.js
        // -----------------------------------------------------------------------------
        const mockWanNianLiData = [
            {"g": "1983-02-04", "y": "癸亥", "m": "1", "d": 2, "dg": "乙卯"}, // Feb 4, 1983 - Li Chun
            {"g": "1983-02-05", "y": "癸亥", "m": "1", "d": 3, "dg": "丙辰"},
            {"g": "1983-02-06", "y": "癸亥", "m": "1", "d": 4, "dg": "丁巳"},
            {"g": "1983-02-07", "y": "癸亥", "m": "1", "d": 5, "dg": "戊午"},
            {"g": "1983-02-08", "y": "癸亥", "m": "1", "d": 6, "dg": "己未"},
            {"g": "1983-02-09", "y": "癸亥", "m": "1", "d": 7, "dg": "庚申"},
            {"g": "1983-02-10", "y": "癸亥", "m": "1", "d": 8, "dg": "辛酉"},
            {"g": "1983-02-11", "y": "癸亥", "m": "1", "d": 9, "dg": "壬戌"},
            {"g": "1983-02-12", "y": "癸亥", "m": "1", "d": 10, "dg": "癸亥"},
            {"g": "1983-02-13", "y": "癸亥", "m": "1", "d": 11, "dg": "甲子"},
            {"g": "1983-02-14", "y": "癸亥", "m": "1", "d": 12, "dg": "乙丑"},
            {"g": "1983-02-15", "y": "癸亥", "m": "1", "d": 13, "dg": "丙寅"},
            {"g": "1983-02-16", "y": "癸亥", "m": "1", "d": 14, "dg": "丁卯"},
            {"g": "1983-02-17", "y": "癸亥", "m": "1", "d": 15, "dg": "戊辰"},
            {"g": "1983-02-18", "y": "癸亥", "m": "1", "d": 16, "dg": "己巳"},
            {"g": "1983-02-19", "y": "癸亥", "m": "1", "d": 17, "dg": "庚午"},
            {"g": "1983-02-20", "y": "癸亥", "m": "1", "d": 18, "dg": "辛未"},
            {"g": "1983-02-21", "y": "癸亥", "m": "1", "d": 19, "dg": "壬申"},
            {"g": "1983-02-22", "y": "癸亥", "m": "1", "d": 20, "dg": "癸酉"},
            {"g": "1983-02-23", "y": "癸亥", "m": "1", "d": 21, "dg": "甲戌"},
            {"g": "1983-02-24", "y": "癸亥", "m": "1", "d": 22, "dg": "乙亥"},
            {"g": "1983-02-25", "y": "癸亥", "m": "1", "d": 23, "dg": "丙子"},
            {"g": "1983-02-26", "y": "癸亥", "m": "1", "d": 24, "dg": "丁丑"},
            {"g": "1983-02-27", "y": "癸亥", "m": "1", "d": 25, "dg": "戊寅"},
            {"g": "1983-03-01", "y": "癸亥", "m": "1", "d": 27, "dg": "庚辰"},
            {"g": "1983-03-02", "y": "癸亥", "m": "1", "d": 28, "dg": "辛巳"},
            {"g": "1983-03-03", "y": "癸亥", "m": "1", "d": 29, "dg": "壬午"},
            {"g": "1983-03-04", "y": "癸亥", "m": "2", "d": 1, "dg": "癸未"}, // Mar 5, 1983 - Jing Zhe
            {"g": "1983-03-05", "y": "癸亥", "m": "2", "d": 2, "dg": "甲申"},
            {"g": "1983-03-06", "y": "癸亥", "m": "2", "d": 3, "dg": "乙酉"},
            {"g": "1983-03-07", "y": "癸亥", "m": "2", "d": 4, "dg": "丙戌"},
            {"g": "1983-03-08", "y": "癸亥", "m": "2", "d": 5, "dg": "丁亥"},
            {"g": "1983-03-09", "y": "癸亥", "m": "2", "d": 6, "dg": "戊子"},
            {"g": "1983-03-10", "y": "癸亥", "m": "2", "d": 7, "dg": "己丑"},
            {"g": "1983-03-11", "y": "癸亥", "m": "2", "d": 8, "dg": "庚寅"},
            {"g": "1983-03-12", "y": "癸亥", "m": "2", "d": 9, "dg": "辛卯"},
            {"g": "1983-03-13", "y": "癸亥", "m": "2", "d": 10, "dg": "壬辰"},
            {"g": "1983-03-14", "y": "癸亥", "m": "2", "d": 11, "dg": "癸巳"},
            {"g": "1983-03-15", "y": "癸亥", "m": "2", "d": 12, "dg": "甲午"},
            {"g": "1983-03-16", "y": "癸亥", "m": "2", "d": 13, "dg": "乙未"},
            {"g": "1983-03-17", "y": "癸亥", "m": "2", "d": 14, "dg": "丙申"},
            {"g": "1983-03-18", "y": "癸亥", "m": "2", "d": 15, "dg": "丁酉"},
            {"g": "1983-03-19", "y": "癸亥", "m": "2", "d": 16, "dg": "戊戌"},
            {"g": "1983-03-20", "y": "癸亥", "m": "2", "d": 17, "dg": "己亥"},
            {"g": "1983-03-21", "y": "癸亥", "m": "2", "d": 18, "dg": "庚子"},
            {"g": "1983-03-22", "y": "癸亥", "m": "2", "d": 19, "dg": "辛丑"},
            {"g": "1983-03-23", "y": "癸亥", "m": "2", "d": 20, "dg": "壬寅"},
            {"g": "1983-03-24", "y": "癸亥", "m": "2", "d": 21, "dg": "癸卯"},
            {"g": "1983-03-25", "y": "癸亥", "m": "2", "d": 22, "dg": "甲辰"},
            {"g": "1983-03-26", "y": "癸亥", "m": "2", "d": 23, "dg": "乙巳"},
            {"g": "1983-03-27", "y": "癸亥", "m": "2", "d": 24, "dg": "丙午"},
            {"g": "1983-03-28", "y": "癸亥", "m": "2", "d": 25, "dg": "丁未"},
            {"g": "1983-03-29", "y": "癸亥", "m": "2", "d": 26, "dg": "戊申"},
            {"g": "1983-03-30", "y": "癸亥", "m": "2", "d": 27, "dg": "己酉"},
            {"g": "1983-03-31", "y": "癸亥", "m": "2", "d": 28, "dg": "庚戌"},
            {"g": "1983-04-01", "y": "癸亥", "m": "2", "d": 29, "dg": "辛亥"},
            {"g": "1983-04-02", "y": "癸亥", "m": "2", "d": 30, "dg": "壬子"},
            {"g": "1983-04-03", "y": "癸亥", "m": "3", "d": 1, "dg": "癸丑"},
            {"g": "1983-04-04", "y": "癸亥", "m": "3", "d": 2, "dg": "甲寅"},
            {"g": "1983-04-05", "y": "癸亥", "m": "3", "d": 3, "dg": "乙卯"}, // Apr 5, 1983 - Qing Ming
            {"g": "1983-04-06", "y": "癸亥", "m": "3", "d": 4, "dg": "丙辰"},
            {"g": "1983-04-07", "y": "癸亥", "m": "3", "d": 5, "dg": "丁巳"},
            {"g": "1983-04-08", "y": "癸亥", "m": "3", "d": 6, "dg": "戊午"},
            {"g": "1983-04-09", "y": "癸亥", "m": "3", "d": 7, "dg": "己未"},
            {"g": "1983-04-10", "y": "癸亥", "m": "3", "d": 8, "dg": "庚申"},
            {"g": "1983-04-11", "y": "癸亥", "m": "3", "d": 9, "dg": "辛酉"},
            {"g": "1983-04-12", "y": "癸亥", "m": "3", "d": 10, "dg": "壬戌"},
            {"g": "1983-04-13", "y": "癸亥", "m": "3", "d": 11, "dg": "癸亥"},
            {"g": "1983-04-14", "y": "癸亥", "m": "3", "d": 12, "dg": "甲子"},
            {"g": "1983-04-15", "y": "癸亥", "m": "3", "d": 13, "dg": "乙丑"},
            {"g": "1983-04-16", "y": "癸亥", "m": "3", "d": 14, "dg": "丙寅"},
            {"g": "1983-04-17", "y": "癸亥", "m": "3", "d": 15, "dg": "丁卯"},
            {"g": "1983-04-18", "y": "癸亥", "m": "3", "d": 16, "dg": "戊辰"},
            {"g": "1983-04-19", "y": "癸亥", "m": "3", "d": 17, "dg": "己巳"},
            {"g": "1983-04-20", "y": "癸亥", "m": "3", "d": 18, "dg": "庚午"},
            {"g": "1983-04-21", "y": "癸亥", "m": "3", "d": 19, "dg": "辛未"},
            {"g": "1983-04-22", "y": "癸亥", "m": "3", "d": 20, "dg": "壬申"},
            {"g": "1983-04-23", "y": "癸亥", "m": "3", "d": 21, "dg": "癸酉"},
            {"g": "1983-04-24", "y": "癸亥", "m": "3", "d": 22, "dg": "甲戌"},
            {"g": "1983-04-25", "y": "癸亥", "m": "3", "d": 23, "dg": "乙亥"},
            {"g": "1983-04-26", "y": "癸亥", "m": "3", "d": 24, "dg": "丙子"},
            {"g": "1983-04-27", "y": "癸亥", "m": "3", "d": 25, "dg": "丁丑"},
            {"g": "1983-04-28", "y": "癸亥", "m": "3", "d": 26, "dg": "戊寅"},
            {"g": "1983-04-29", "y": "癸亥", "m": "3", "d": 27, "dg": "己卯"},
            {"g": "1983-04-30", "y": "癸亥", "m": "3", "d": 28, "dg": "庚辰"},
            {"g": "1983-05-01", "y": "癸亥", "m": "3", "d": 29, "dg": "辛巳"},
            {"g": "1983-05-02", "y": "癸亥", "m": "3", "d": 30, "dg": "壬午"},
            {"g": "1983-05-03", "y": "癸亥", "m": "4", "d": 1, "dg": "癸未"},
            {"g": "1983-05-04", "y": "癸亥", "m": "4", "d": 2, "dg": "甲申"},
            {"g": "1983-05-05", "y": "癸亥", "m": "4", "d": 3, "dg": "乙酉"}, // May 6, 1983 - Li Xia
            {"g": "1983-05-06", "y": "癸亥", "m": "4", "d": 4, "dg": "丙戌"},
            {"g": "1983-05-07", "y": "癸亥", "m": "4", "d": 5, "dg": "丁亥"},
            {"g": "1983-05-08", "y": "癸亥", "m": "4", "d": 6, "dg": "戊子"},
            {"g": "1983-05-09", "y": "癸亥", "m": "4", "d": 7, "dg": "己丑"},
            {"g": "1983-05-10", "y": "癸亥", "m": "4", "d": 8, "dg": "庚寅"},
            {"g": "1983-05-11", "y": "癸亥", "m": "4", "d": 9, "dg": "辛卯"},
            {"g": "1983-05-12", "y": "癸亥", "m": "4", "d": 10, "dg": "壬辰"},
            {"g": "1983-05-13", "y": "癸亥", "m": "4", "d": 11, "dg": "癸巳"},
            {"g": "1983-05-14", "y": "癸亥", "m": "4", "d": 12, "dg": "甲午"},
            {"g": "1983-05-15", "y": "癸亥", "m": "4", "d": 13, "dg": "乙未"},
            {"g": "1983-05-16", "y": "癸亥", "m": "4", "d": 14, "dg": "丙申"},
            {"g": "1983-05-17", "y": "癸亥", "m": "4", "d": 15, "dg": "丁酉"},
            {"g": "1983-05-18", "y": "癸亥", "m": "4", "d": 16, "dg": "戊戌"},
            {"g": "1983-05-19", "y": "癸亥", "m": "4", "d": 17, "dg": "己亥"},
            {"g": "1983-05-20", "y": "癸亥", "m": "4", "d": 18, "dg": "庚子"},
            {"g": "1983-05-21", "y": "癸亥", "m": "4", "d": 19, "dg": "辛丑"},
            {"g": "1983-05-22", "y": "癸亥", "m": "4", "d": 20, "dg": "壬寅"},
            {"g": "1983-05-23", "y": "癸亥", "m": "4", "d": 21, "dg": "癸卯"},
            {"g": "1983-05-24", "y": "癸亥", "m": "4", "d": 22, "dg": "甲辰"},
            {"g": "1983-05-25", "y": "癸亥", "m": "4", "d": 23, "dg": "乙巳"},
            {"g": "1983-05-26", "y": "癸亥", "m": "4", "d": 24, "dg": "丙午"},
            {"g": "1983-05-27", "y": "癸亥", "m": "4", "d": 25, "dg": "丁未"},
            {"g": "1983-05-28", "y": "癸亥", "m": "4", "d": 26, "dg": "戊申"},
            {"g": "1983-05-29", "y": "癸亥", "m": "4", "d": 27, "dg": "己酉"},
            {"g": "1983-05-30", "y": "癸亥", "m": "4", "d": 28, "dg": "庚戌"},
            {"g": "1983-05-31", "y": "癸亥", "m": "4", "d": 29, "dg": "辛亥"},
            {"g": "1983-06-01", "y": "癸亥", "m": "4", "d": 30, "dg": "壬子"},
            {"g": "1983-06-02", "y": "癸亥", "m": "5", "d": 1, "dg": "癸丑"},
            {"g": "1983-06-03", "y": "癸亥", "m": "5", "d": 2, "dg": "甲寅"},
            {"g": "1983-06-04", "y": "癸亥", "m": "5", "d": 3, "dg": "乙卯"},
            {"g": "1983-06-05", "y": "癸亥", "m": "5", "d": 4, "dg": "丙辰"}, // Jun 6, 1983 - Mang Zhong
            {"g": "1983-06-06", "y": "癸亥", "m": "5", "d": 5, "dg": "丁巳"},
            {"g": "1983-06-07", "y": "癸亥", "m": "5", "d": 6, "dg": "戊午"},
            {"g": "1983-06-08", "y": "癸亥", "m": "5", "d": 7, "dg": "己未"},
            {"g": "1983-06-09", "y": "癸亥", "m": "5", "d": 8, "dg": "庚申"},
            {"g": "1983-06-10", "y": "癸亥", "m": "5", "d": 9, "dg": "辛酉"},
            {"g": "1983-06-11", "y": "癸亥", "m": "5", "d": 10, "dg": "壬戌"},
            {"g": "1983-06-12", "y": "癸亥", "m": "5", "d": 11, "dg": "癸亥"},
            {"g": "1983-06-13", "y": "癸亥", "m": "5", "d": 12, "dg": "甲子"},
            {"g": "1983-06-14", "y": "癸亥", "m": "5", "d": 13, "dg": "乙丑"},
            {"g": "1983-06-15", "y": "癸亥", "m": "5", "d": 14, "dg": "丙寅"},
            {"g": "1983-06-16", "y": "癸亥", "m": "5", "d": 15, "dg": "丁卯"},
            {"g": "1983-06-17", "y": "癸亥", "m": "5", "d": 16, "dg": "戊辰"},
            {"g": "1983-06-18", "y": "癸亥", "m": "5", "d": 17, "dg": "己巳"},
            {"g": "1983-06-19", "y": "癸亥", "m": "5", "d": 18, "dg": "庚午"},
            {"g": "1983-06-20", "y": "癸亥", "m": "5", "d": 19, "dg": "辛未"},
            {"g": "1983-06-21", "y": "癸亥", "m": "5", "d": 20, "dg": "壬申"},
            {"g": "1983-06-22", "y": "癸亥", "m": "5", "d": 21, "dg": "癸酉"},
            {"g": "1983-06-23", "y": "癸亥", "m": "5", "d": 22, "dg": "甲戌"},
            {"g": "1983-06-24", "y": "癸亥", "m": "5", "d": 23, "dg": "乙亥"},
            {"g": "1983-06-25", "y": "癸亥", "m": "5", "d": 24, "dg": "丙子"},
            {"g": "1983-06-26", "y": "癸亥", "m": "5", "d": 25, "dg": "丁丑"},
            {"g": "1983-06-27", "y": "癸亥", "m": "5", "d": 26, "dg": "戊寅"},
            {"g": "1983-06-28", "y": "癸亥", "m": "5", "d": 27, "dg": "己卯"},
            {"g": "1983-06-29", "y": "癸亥", "m": "5", "d": 28, "dg": "庚辰"},
            {"g": "1983-06-30", "y": "癸亥", "m": "5", "d": 29, "dg": "辛巳"},
            {"g": "1983-07-01", "y": "癸亥", "m": "5", "d": 30, "dg": "壬午"},
            {"g": "1983-07-02", "y": "癸亥", "m": "6", "d": 1, "dg": "癸未"},
            {"g": "1983-07-03", "y": "癸亥", "m": "6", "d": 2, "dg": "甲申"},
            {"g": "1983-07-04", "y": "癸亥", "m": "6", "d": 3, "dg": "乙酉"},
            {"g": "1983-07-05", "y": "癸亥", "m": "6", "d": 4, "dg": "丙戌"},
            {"g": "1983-07-06", "y": "癸亥", "m": "6", "d": 5, "dg": "丁亥"}, // Jul 7, 1983 - Xiaoshu
            {"g": "1983-07-07", "y": "癸亥", "m": "6", "d": 6, "dg": "戊子"},
            {"g": "1983-07-08", "y": "癸亥", "m": "6", "d": 7, "dg": "己丑"},
            {"g": "1983-07-09", "y": "癸亥", "m": "6", "d": 8, "dg": "庚寅"},
            {"g": "1983-07-10", "y": "癸亥", "m": "6", "d": 9, "dg": "辛卯"},
            {"g": "1983-07-11", "y": "癸亥", "m": "6", "d": 10, "dg": "壬辰"},
            {"g": "1983-07-12", "y": "癸亥", "m": "6", "d": 11, "dg": "癸巳"},
            {"g": "1983-07-13", "y": "癸亥", "m": "6", "d": 12, "dg": "甲午"},
            {"g": "1983-07-14", "y": "癸亥", "m": "6", "d": 13, "dg": "乙未"},
            {"g": "1983-07-15", "y": "癸亥", "m": "6", "d": 14, "dg": "丙申"},
            {"g": "1983-07-16", "y": "癸亥", "m": "6", "d": 15, "dg": "丁酉"},
            {"g": "1983-07-17", "y": "癸亥", "m": "6", "d": 16, "dg": "戊戌"},
            {"g": "1983-07-18", "y": "癸亥", "m": "6", "d": 17, "dg": "己亥"},
            {"g": "1983-07-19", "y": "癸亥", "m": "6", "d": 18, "dg": "庚子"},
            {"g": "1983-07-20", "y": "癸亥", "m": "6", "d": 19, "dg": "辛丑"},
            {"g": "1983-07-21", "y": "癸亥", "m": "6", "d": 20, "dg": "壬寅"},
            {"g": "1983-07-22", "y": "癸亥", "m": "6", "d": 21, "dg": "癸卯"},
            {"g": "1983-07-23", "y": "癸亥", "m": "6", "d": 22, "dg": "甲辰"},
            {"g": "1983-07-24", "y": "癸亥", "m": "6", "d": 23, "dg": "乙巳"},
            {"g": "1983-07-25", "y": "癸亥", "m": "6", "d": 24, "dg": "丙午"},
            {"g": "1983-07-26", "y": "癸亥", "m": "6", "d": 25, "dg": "丁未"},
            {"g": "1983-07-27", "y": "癸亥", "m": "6", "d": 26, "dg": "戊申"},
            {"g": "1983-07-28", "y": "癸亥", "m": "6", "d": 27, "dg": "己酉"},
            {"g": "1983-07-29", "y": "癸亥", "m": "6", "d": 28, "dg": "庚戌"},
            {"g": "1983-07-30", "y": "癸亥", "m": "6", "d": 29, "dg": "辛亥"},
            {"g": "1983-07-31", "y": "癸亥", "m": "6", "d": 30, "dg": "壬子"},
            {"g": "1983-08-01", "y": "癸亥", "m": "7", "d": 1, "dg": "癸丑"},
            {"g": "1983-08-02", "y": "癸亥", "m": "7", "d": 2, "dg": "甲寅"},
            {"g": "1983-08-03", "y": "癸亥", "m": "7", "d": 3, "dg": "乙卯"},
            {"g": "1983-08-04", "y": "癸亥", "m": "7", "d": 4, "dg": "丙辰"},
            {"g": "1983-08-05", "y": "癸亥", "m": "7", "d": 5, "dg": "丁巳"},
            {"g": "1983-08-06", "y": "癸亥", "m": "7", "d": 6, "dg": "戊午"}, // Aug 8, 1983 - Liqiu
            {"g": "1983-08-07", "y": "癸亥", "m": "7", "d": 7, "dg": "己未"},
            {"g": "1983-08-08", "y": "癸亥", "m": "7", "d": 8, "dg": "庚申"},
            {"g": "1983-08-09", "y": "癸亥", "m": "7", "d": 9, "dg": "辛酉"},
            {"g": "1983-08-10", "y": "癸亥", "m": "7", "d": 10, "dg": "壬戌"},
            {"g": "1983-08-11", "y": "癸亥", "m": "7", "d": 11, "dg": "癸亥"},
            {"g": "1983-08-12", "y": "癸亥", "m": "7", "d": 12, "dg": "甲子"},
            {"g": "1983-08-13", "y": "癸亥", "m": "7", "d": 13, "dg": "乙丑"},
            {"g": "1983-08-14", "y": "癸亥", "m": "7", "d": 14, "dg": "丙寅"},
            {"g": "1983-08-15", "y": "癸亥", "m": "7", "d": 15, "dg": "丁卯"},
            {"g": "1983-08-16", "y": "癸亥", "m": "7", "d": 16, "dg": "戊辰"},
            {"g": "1983-08-17", "y": "癸亥", "m": "7", "d": 17, "dg": "己巳"},
            {"g": "1983-08-18", "y": "癸亥", "m": "7", "d": 18, "dg": "庚午"},
            {"g": "1983-08-19", "y": "癸亥", "m": "7", "d": 19, "dg": "辛未"},
            {"g": "1983-08-20", "y": "癸亥", "m": "7", "d": 20, "dg": "壬申"},
            {"g": "1983-08-21", "y": "癸亥", "m": "7", "d": 21, "dg": "癸酉"},
            {"g": "1983-08-22", "y": "癸亥", "m": "7", "d": 22, "dg": "甲戌"},
            {"g": "1983-08-23", "y": "癸亥", "m": "7", "d": 23, "dg": "乙亥"},
            {"g": "1983-08-24", "y": "癸亥", "m": "7", "d": 24, "dg": "丙子"},
            {"g": "1983-08-25", "y": "癸亥", "m": "7", "d": 25, "dg": "丁丑"},
            {"g": "1983-08-26", "y": "癸亥", "m": "7", "d": 26, "dg": "戊寅"},
            {"g": "1983-08-27", "y": "癸亥", "m": "7", "d": 27, "dg": "己卯"},
            {"g": "1983-08-28", "y": "癸亥", "m": "7", "d": 28, "dg": "庚辰"},
            {"g": "1983-08-29", "y": "癸亥", "m": "7", "d": 29, "dg": "辛巳"},
            {"g": "1983-08-30", "y": "癸亥", "m": "7", "d": 30, "dg": "壬午"},
            {"g": "1983-08-31", "y": "癸亥", "m": "8", "d": 1, "dg": "癸未"},
            {"g": "1983-09-01", "y": "癸亥", "m": "8", "d": 2, "dg": "甲申"},
            {"g": "1983-09-02", "y": "癸亥", "m": "8", "d": 3, "dg": "乙酉"},
            {"g": "1983-09-03", "y": "癸亥", "m": "8", "d": 4, "dg": "丙戌"},
            {"g": "1983-09-04", "y": "癸亥", "m": "8", "d": 5, "dg": "丁亥"},
            {"g": "1983-09-05", "y": "癸亥", "m": "8", "d": 6, "dg": "戊子"},
            {"g": "1983-09-06", "y": "癸亥", "m": "8", "d": 7, "dg": "己丑"}, // Sep 8, 1983 - Bailu
            {"g": "1983-09-07", "y": "癸亥", "m": "8", "d": 8, "dg": "庚寅"},
            {"g": "1983-09-08", "y": "癸亥", "m": "8", "d": 9, "dg": "辛卯"},
            {"g": "1983-09-09", "y": "癸亥", "m": "8", "d": 10, "dg": "壬辰"},
            {"g": "1983-09-10", "y": "癸亥", "m": "8", "d": 11, "dg": "癸巳"},
            {"g": "1983-09-11", "y": "癸亥", "m": "8", "d": 12, "dg": "甲午"},
            {"g": "1983-09-12", "y": "癸亥", "m": "8", "d": 13, "dg": "乙未"},
            {"g": "1983-09-13", "y": "癸亥", "m": "8", "d": 14, "dg": "丙申"},
            {"g": "1983-09-14", "y": "癸亥", "m": "8", "d": 15, "dg": "丁酉"},
            {"g": "1983-09-15", "y": "癸亥", "m": "8", "d": 16, "dg": "戊戌"},
            {"g": "1983-09-16", "y": "癸亥", "m": "8", "d": 17, "dg": "己亥"},
            {"g": "1983-09-17", "y": "癸亥", "m": "8", "d": 18, "dg": "庚子"},
            {"g": "1983-09-18", "y": "癸亥", "m": "8", "d": 19, "dg": "辛丑"},
            {"g": "1983-09-19", "y": "癸亥", "m": "8", "d": 20, "dg": "壬寅"},
            {"g": "1983-09-20", "y": "癸亥", "m": "8", "d": 21, "dg": "癸卯"},
            {"g": "1983-09-21", "y": "癸亥", "m": "8", "d": 22, "dg": "甲辰"},
            {"g": "1983-09-22", "y": "癸亥", "m": "8", "d": 23, "dg": "乙巳"},
            {"g": "1983-09-23", "y": "癸亥", "m": "8", "d": 24, "dg": "丙午"},
            {"g": "1983-09-24", "y": "癸亥", "m": "8", "d": 25, "dg": "丁未"},
            {"g": "1983-09-25", "y": "癸亥", "m": "8", "d": 26, "dg": "戊申"},
            {"g": "1983-09-26", "y": "癸亥", "m": "8", "d": 27, "dg": "己酉"},
            {"g": "1983-09-27", "y": "癸亥", "m": "8", "d": 28, "dg": "庚戌"},
            {"g": "1983-09-28", "y": "癸亥", "m": "8", "d": 29, "dg": "辛亥"},
            {"g": "1983-09-29", "y": "癸亥", "m": "8", "d": 30, "dg": "壬子"},
            {"g": "1983-09-30", "y": "癸亥", "m": "9", "d": 1, "dg": "癸丑"},
            {"g": "1983-10-01", "y": "癸亥", "m": "9", "d": 2, "dg": "甲寅"},
            {"g": "1983-10-02", "y": "癸亥", "m": "9", "d": 3, "dg": "乙卯"},
            {"g": "1983-10-03", "y": "癸亥", "m": "9", "d": 4, "dg": "丙辰"},
            {"g": "1983-10-04", "y": "癸亥", "m": "9", "d": 5, "dg": "丁巳"},
            {"g": "1983-10-05", "y": "癸亥", "m": "9", "d": 6, "dg": "戊午"}, // Oct 8, 1983 - Hanlu
            {"g": "1983-10-06", "y": "癸亥", "m": "9", "d": 7, "dg": "己未"},
            {"g": "1983-10-07", "y": "癸亥", "m": "9", "d": 8, "dg": "庚申"},
            {"g": "1983-10-08", "y": "癸亥", "m": "9", "d": 9, "dg": "辛酉"},
            {"g": "1983-10-09", "y": "癸亥", "m": "9", "d": 10, "dg": "壬戌"},
            {"g": "1983-10-10", "y": "癸亥", "m": "9", "d": 11, "dg": "癸亥"},
            {"g": "1983-10-11", "y": "癸亥", "m": "9", "d": 12, "dg": "甲子"},
            {"g": "1983-10-12", "y": "癸亥", "m": "9", "d": 13, "dg": "乙丑"},
            {"g": "1983-10-13", "y": "癸亥", "m": "9", "d": 14, "dg": "丙寅"},
            {"g": "1983-10-14", "y": "癸亥", "m": "9", "d": 15, "dg": "丁卯"},
            {"g": "1983-10-15", "y": "癸亥", "m": "9", "d": 16, "dg": "戊辰"},
            {"g": "1983-10-16", "y": "癸亥", "m": "9", "d": 17, "dg": "己巳"},
            {"g": "1983-10-17", "y": "癸亥", "m": "9", "d": 18, "dg": "庚午"},
            {"g": "1983-10-18", "y": "癸亥", "m": "9", "d": 19, "dg": "辛未"},
            {"g": "1983-10-19", "y": "癸亥", "m": "9", "d": 20, "dg": "壬申"},
            {"g": "1983-10-20", "y": "癸亥", "m": "9", "d": 21, "dg": "癸酉"},
            {"g": "1983-10-21", "y": "癸亥", "m": "9", "d": 22, "dg": "甲戌"},
            {"g": "1983-10-22", "y": "癸亥", "m": "9", "d": 23, "dg": "乙亥"},
            {"g": "1983-10-23", "y": "癸亥", "m": "9", "d": 24, "dg": "丙子"},
            {"g": "1983-10-24", "y": "癸亥", "m": "9", "d": 25, "dg": "丁丑"},
            {"g": "1983-10-25", "y": "癸亥", "m": "9", "d": 26, "dg": "戊寅"},
            {"g": "1983-10-26", "y": "癸亥", "m": "9", "d": 27, "dg": "己卯"},
            {"g": "1983-10-27", "y": "癸亥", "m": "9", "d": 28, "dg": "庚辰"},
            {"g": "1983-10-28", "y": "癸亥", "m": "9", "d": 29, "dg": "辛巳"},
            {"g": "1983-10-29", "y": "癸亥", "m": "9", "d": 30, "dg": "壬午"},
            {"g": "1983-10-30", "y": "癸亥", "m": "10", "d": 1, "dg": "癸未"},
            {"g": "1983-10-31", "y": "癸亥", "m": "10", "d": 2, "dg": "甲申"},
            {"g": "1983-11-01", "y": "癸亥", "m": "10", "d": 3, "dg": "乙酉"},
            {"g": "1983-11-02", "y": "癸亥", "m": "10", "d": 4, "dg": "丙戌"},
            {"g": "1983-11-03", "y": "癸亥", "m": "10", "d": 5, "dg": "丁亥"},
            {"g": "1983-11-04", "y": "癸亥", "m": "10", "d": 6, "dg": "戊子"},
            {"g": "1983-11-05", "y": "癸亥", "m": "10", "d": 7, "dg": "己丑"},
            {"g": "1983-11-06", "y": "癸亥", "m": "10", "d": 8, "dg": "庚寅"},
            {"g": "1983-11-07", "y": "癸亥", "m": "10", "d": 9, "dg": "辛卯"}, // Nov 8, 1983 - Lidong
            {"g": "1983-11-08", "y": "癸亥", "m": "10", "d": 10, "dg": "壬辰"},
            {"g": "1983-11-09", "y": "癸亥", "m": "10", "d": 11, "dg": "癸巳"},
            {"g": "1983-11-10", "y": "癸亥", "m": "10", "d": 12, "dg": "甲午"},
            {"g": "1983-11-11", "y": "癸亥", "m": "10", "d": 13, "dg": "癸卯"}, // The test date
            {"g": "1983-11-12", "y": "癸亥", "m": "10", "d": 14, "dg": "丙申"},
            {"g": "1983-11-13", "y": "癸亥", "m": "10", "d": 15, "dg": "丁酉"},
            {"g": "1983-11-14", "y": "癸亥", "m": "10", "d": 16, "dg": "戊戌"},
            {"g": "1983-11-15", "y": "癸亥", "m": "10", "d": 17, "dg": "己亥"},
            {"g": "1983-11-16", "y": "癸亥", "m": "10", "d": 18, "dg": "庚子"},
            {"g": "1983-11-17", "y": "癸亥", "m": "10", "d": 19, "dg": "辛丑"},
            {"g": "1983-11-18", "y": "癸亥", "m": "10", "d": 20, "dg": "壬寅"},
            {"g": "1983-11-19", "y": "癸亥", "m": "10", "d": 21, "dg": "癸卯"},
            {"g": "1983-11-20", "y": "癸亥", "m": "10", "d": 22, "dg": "甲辰"},
            {"g": "1983-11-21", "y": "癸亥", "m": "10", "d": 23, "dg": "乙巳"},
            {"g": "1983-11-22", "y": "癸亥", "m": "10", "d": 24, "dg": "丙午"},
            {"g": "1983-11-23", "y": "癸亥", "m": "10", "d": 25, "dg": "丁未"},
            {"g": "1983-11-24", "y": "癸亥", "m": "10", "d": 26, "dg": "戊申"},
            {"g": "1983-11-25", "y": "癸亥", "m": "10", "d": 27, "dg": "己酉"},
            {"g": "1983-11-26", "y": "癸亥", "m": "10", "d": 28, "dg": "庚戌"},
            {"g": "1983-11-27", "y": "癸亥", "m": "10", "d": 29, "dg": "辛亥"},
            {"g": "1983-11-28", "y": "癸亥", "m": "10", "d": 30, "dg": "壬子"},
            {"g": "1983-11-29", "y": "癸亥", "m": "11", "d": 1, "dg": "癸丑"},
            {"g": "1983-11-30", "y": "癸亥", "m": "11", "d": 2, "dg": "甲寅"},
            {"g": "1983-12-01", "y": "癸亥", "m": "11", "d": 3, "dg": "乙卯"},
            {"g": "1983-12-02", "y": "癸亥", "m": "11", "d": 4, "dg": "丙辰"},
            {"g": "1983-12-03", "y": "癸亥", "m": "11", "d": 5, "dg": "丁巳"},
            {"g": "1983-12-04", "y": "癸亥", "m": "11", "d": 6, "dg": "戊午"},
            {"g": "1983-12-05", "y": "癸亥", "m": "11", "d": 7, "dg": "己未"},
            {"g": "1983-12-06", "y": "癸亥", "m": "11", "d": 8, "dg": "庚申"}, // Dec 7, 1983 - Daxue
            {"g": "1983-12-07", "y": "癸亥", "m": "11", "d": 9, "dg": "辛酉"},
            {"g": "1983-12-08", "y": "癸亥", "m": "11", "d": 10, "dg": "壬戌"},
            {"g": "1983-12-09", "y": "癸亥", "m": "11", "d": 11, "dg": "癸亥"},
            {"g": "1983-12-10", "y": "癸亥", "m": "11", "d": 12, "dg": "甲子"},
            {"g": "1983-12-11", "y": "癸亥", "m": "11", "d": 13, "dg": "乙丑"},
            {"g": "1983-12-12", "y": "癸亥", "m": "11", "d": 14, "dg": "丙寅"},
            {"g": "1983-12-13", "y": "癸亥", "m": "11", "d": 15, "dg": "丁卯"},
            {"g": "1983-12-14", "y": "癸亥", "m": "11", "d": 16, "dg": "戊辰"},
            {"g": "1983-12-15", "y": "癸亥", "m": "11", "d": 17, "dg": "己巳"},
            {"g": "1983-12-16", "y": "癸亥", "m": "11", "d": 18, "dg": "庚午"},
            {"g": "1983-12-17", "y": "癸亥", "m": "11", "d": 19, "dg": "辛未"},
            {"g": "1983-12-18", "y": "癸亥", "m": "11", "d": 20, "dg": "壬申"},
            {"g": "1983-12-19", "y": "癸亥", "m": "11", "d": 21, "dg": "癸酉"},
            {"g": "1983-12-20", "y": "癸亥", "m": "11", "d": 22, "dg": "甲戌"},
            {"g": "1983-12-21", "y": "癸亥", "m": "11", "d": 23, "dg": "乙亥"}, // Dec 22, 1983 - Dongzhi (Winter Solstice)
            {"g": "1983-12-22", "y": "癸亥", "m": "11", "d": 24, "dg": "丙子"},
            {"g": "1983-12-23", "y": "癸亥", "m": "11", "d": 25, "dg": "丁丑"},
            {"g": "1983-12-24", "y": "癸亥", "m": "11", "d": 26, "dg": "戊寅"},
            {"g": "1983-12-25", "y": "癸亥", "m": "11", "d": 27, "dg": "己卯"},
            {"g": "1983-12-26", "y": "癸亥", "m": "11", "d": 28, "dg": "庚辰"},
            {"g": "1983-12-27", "y": "癸亥", "m": "11", "d": 29, "dg": "辛巳"},
            {"g": "1983-12-28", "y": "癸亥", "m": "11", "d": 30, "dg": "壬午"},
            {"g": "1983-12-29", "y": "癸亥", "m": "12", "d": 1, "dg": "癸未"},
            {"g": "1983-12-30", "y": "癸亥", "m": "12", "d": 2, "dg": "甲申"},
            {"g": "1983-12-31", "y": "癸亥", "m": "12", "d": 3, "dg": "乙酉"},
            {"g": "1984-01-01", "y": "癸亥", "m": "12", "d": 4, "dg": "丙戌"},
            {"g": "1984-01-02", "y": "癸亥", "m": "12", "d": 5, "dg": "丁亥"},
            {"g": "1984-01-03", "y": "癸亥", "m": "12", "d": 6, "dg": "戊子"},
            {"g": "1984-01-04", "y": "癸亥", "m": "12", "d": 7, "dg": "己丑"},
            {"g": "1984-01-05", "y": "癸亥", "m": "12", "d": 8, "dg": "庚寅"}, // Jan 6, 1984 - Xiaohan
            {"g": "1984-01-06", "y": "癸亥", "m": "12", "d": 9, "dg": "辛卯"},
            {"g": "1984-01-07", "y": "癸亥", "m": "12", "d": 10, "dg": "壬辰"},
            {"g": "1984-01-08", "y": "癸亥", "m": "12", "d": 11, "dg": "癸巳"},
            {"g": "1984-01-09", "y": "癸亥", "m": "12", "d": 12, "dg": "甲午"},
            {"g": "1984-01-10", "y": "癸亥", "m": "12", "d": 13, "dg": "乙未"},
            {"g": "1984-01-11", "y": "癸亥", "m": "12", "d": 14, "dg": "丙申"},
            {"g": "1984-01-12", "y": "癸亥", "m": "12", "d": 15, "dg": "丁酉"},
            {"g": "1984-01-13", "y": "癸亥", "m": "12", "d": 16, "dg": "戊戌"},
            {"g": "1984-01-14", "y": "癸亥", "m": "12", "d": 17, "dg": "己亥"},
            {"g": "1984-01-15", "y": "癸亥", "m": "12", "d": 18, "dg": "庚子"},
            {"g": "1984-01-16", "y": "癸亥", "m": "12", "d": 19, "dg": "辛丑"},
            {"g": "1984-01-17", "y": "癸亥", "m": "12", "d": 20, "dg": "壬寅"},
            {"g": "1984-01-18", "y": "癸亥", "m": "12", "d": 21, "dg": "癸卯"},
            {"g": "1984-01-19", "y": "癸亥", "m": "12", "d": 22, "dg": "甲辰"},
            {"g": "1984-01-20", "y": "癸亥", "m": "12", "d": 23, "dg": "乙巳"},
            {"g": "1984-01-21", "y": "癸亥", "m": "12", "d": 24, "dg": "丙午"},
            {"g": "1984-01-22", "y": "癸亥", "m": "12", "d": 25, "dg": "丁未"},
            {"g": "1984-01-23", "y": "癸亥", "m": "12", "d": 26, "dg": "戊申"},
            {"g": "1984-01-24", "y": "癸亥", "m": "12", "d": 27, "dg": "己酉"},
            {"g": "1984-01-25", "y": "癸亥", "m": "12", "d": 28, "dg": "庚戌"},
            {"g": "1984-01-26", "y": "癸亥", "m": "12", "d": 29, "dg": "辛亥"},
            {"g": "1984-01-27", "y": "癸亥", "m": "12", "d": 30, "dg": "壬子"},
            {"g": "1984-01-28", "y": "癸亥", "m": "12", "d": 31, "dg": "癸丑"},
            {"g": "1984-01-29", "y": "癸亥", "m": "12", "d": 32, "dg": "甲寅"},
            {"g": "1984-01-30", "y": "癸亥", "m": "12", "d": 33, "dg": "乙卯"},
            {"g": "1984-01-31", "y": "癸亥", "m": "12", "d": 34, "dg": "丙辰"},
            {"g": "1984-02-01", "y": "癸亥", "m": "12", "d": 35, "dg": "丁巳"},
            {"g": "1984-02-02", "y": "癸亥", "m": "12", "d": 36, "dg": "戊午"},
            {"g": "1984-02-03", "y": "癸亥", "m": "12", "d": 37, "dg": "己未"},
            {"g": "1984-02-04", "y": "甲子", "m": "1", "d": 1, "dg": "庚申"} // Feb 4, 1984 - Li Chun (New Year)
        ];

        // MOCK solarTermMap for browser testing
        // This is a small subset; real application would load the full JSON.
        const solarTermMap = {
            "1983": [
                {"term": "Lichun", "type": "Jie", "jd": 2445371.32049}, // Feb 4, 1983
                {"term": "Jingzhe", "type": "Jie", "jd": 2445401.59477}, // Mar 5, 1983
                {"term": "Qingming", "type": "Jie", "jd": 2445432.22171}, // Apr 5, 1983
                {"term": "Lixia", "type": "Jie", "jd": 2445462.67382}, // May 6, 1983
                {"term": "Mangzhong", "type": "Jie", "jd": 2445493.59302}, // Jun 6, 1983
                {"term": "Xiaoshu", "type": "Jie", "jd": 2445524.32168}, // Jul 7, 1983
                {"term": "Liqiu", "type": "Jie", "jd": 2445554.81977}, // Aug 8, 1983
                {"term": "Bailu", "type": "Jie", "jd": 2445585.34006}, // Sep 8, 1983
                {"term": "Hanlu", "type": "Jie", "jd": 2445615.82084}, // Oct 8, 1983
                {"term": "Lidong", "type": "Jie", "jd": 2445646.40224}, // Nov 8, 1983
                {"term": "Daxue", "type": "Jie", "jd": 2445677.30063}, // Dec 7, 1983
                {"term": "Xiaohan", "type": "Jie", "jd": 2445707.97193}  // Jan 6, 1984
            ],
            "1984": [
                {"term": "Lichun", "type": "Jie", "jd": 2445738.64722} // Feb 4, 1984
            ]
        };

        // -----------------------------------------------------------------------------
        // MOCK supabase client for WanNianLi data
        // From original bazi.js
        // -----------------------------------------------------------------------------
        const supabase = {
          from: (table) => ({
            select: (columns) => ({
              eq: (column, value) => ({
                single: async () => {
                  if (table === 'wanianli') {
                    const data = mockWanNianLiData.find(d => d.g === value);
                    if (data) {
                      return { 
                        data: { 
                          day_ganzhi: data.dg,
                          lunar_year_gz: data.y,
                          lunar_month: data.m,
                          lunar_day: data.d
                        }, 
                        error: null 
                      };
                    }
                    return { data: null, error: new Error('Data not found in mockWanNianLiData') };
                  }
                  return { data: null, error: new Error('Mock: Unknown table') };
                }
              })
            })
          })
        };

        // -----------------------------------------------------------------------------
        // Constants (from api/constants.js)
        // -----------------------------------------------------------------------------
        const HEAVENLY_STEMS = [
          { chinese: '甲', pinyin: 'Jiǎ', number: 1, element: 'Yang Wood', color: '#90ee90', textColor: '#006400', description: 'Yang Wood represents the beginning of growth, like a seed sprouting or a young plant' },
          { chinese: '乙', pinyin: 'Yǐ', number: 2, element: 'Yin Wood', color: '#90ee90', textColor: '#006400', description: 'Yin Wood represents mature trees, flowers, and flexible wooden items' },
          { chinese: '丙', pinyin: 'Bǐng', number: 3, element: 'Yang Fire', color: '#ffcccc', textColor: '#8b0000', description: 'Yang Fire represents the sun, intense heat, and illuminating flame' },
          { chinese: '丁', pinyin: 'Dīng', number: 4, element: 'Yin Fire', color: '#ffcccc', textColor: '#8b0000', description: 'Yin Fire represents candles, cooking fire, and subtle warmth' },
          { chinese: '戊', pinyin: 'Wù', number: 5, element: 'Yang Earth', color: '#f5deb3', textColor: '#8b4513', description: 'Yang Earth represents mountains, large landscapes, and strong foundation' },
          { chinese: '己', pinyin: 'Jǐ', number: 6, element: 'Yin Earth', color: '#f5deb3', textColor: '#8b4513', description: 'Yin Earth represents soil, farming land, and pottery' },
          { chinese: '庚', pinyin: 'Gēng', number: 7, element: 'Yang Metal', color: '#d3d3d3', textColor: '#2f4f4f', description: 'Yang Metal represents hard metals, weapons, and firm determination' },
          { chinese: '辛', pinyin: 'Xīn', number: 8, element: 'Yin Metal', color: '#d3d3d3', textColor: '#2f4f4f', description: 'Yin Metal represents jewelry, decorative metals, and precision instruments' },
          { chinese: '壬', pinyin: 'Rén', number: 9, element: 'Yang Water', color: '#add8e6', textColor: '#00008b', description: 'Yang Water represents oceans, large rivers, and strong currents' },
          { chinese: '癸', pinyin: 'Guǐ', number: 10, element: 'Yin Water', color: '#add8e6', textColor: '#00008b', description: 'Yin Water represents rain, dew, small streams, and gentle moisture' }
        ];

        const EARTHLY_BRANCHES = [
          { chinese: '子', pinyin: 'Zǐ', animal: 'Rat', element: 'Yang Water', color: '#add8e6', textColor: '#00008b', hiddenStems: [{ chinese: '癸', pinyin: 'Guǐ', element: 'Yin Water' }], hours: '23:00-00:59', direction: 'North', season: 'Mid-Winter', month: 11 },
          { chinese: '丑', pinyin: 'Chǒu', animal: 'Ox', element: 'Yin Earth', color: '#f5deb3', textColor: '#8b4513', hiddenStems: [{ chinese: '己', pinyin: 'Jǐ', element: 'Yin Earth' }, { chinese: '癸', pinyin: 'Guǐ', element: 'Yin Water' }, { chinese: '辛', pinyin: 'Xīn', element: 'Yin Metal' }], hours: '01:00-02:59', direction: 'North-Northeast', season: 'Late Winter', month: 12 },
          { chinese: '寅', pinyin: 'Yín', animal: 'Tiger', element: 'Yang Wood', color: '#90ee90', textColor: '#006400', hiddenStems: [{ chinese: '甲', pinyin: 'Jiǎ', element: 'Yang Wood' }, { chinese: '丙', pinyin: 'Bǐng', element: 'Yang Fire' }, { chinese: '戊', pinyin: 'Wù', element: 'Yang Earth' }], hours: '03:00-04:59', direction: 'East-Northeast', season: 'Early Spring', month: 1 },
          { chinese: '卯', pinyin: 'Mǎo', animal: 'Rabbit', element: 'Yin Wood', color: '#90ee90', textColor: '#006400', hiddenStems: [{ chinese: '乙', pinyin: 'Yǐ', element: 'Yin Wood' }], hours: '05:00-06:59', direction: 'East', season: 'Mid-Spring', month: 2 },
          { chinese: '辰', pinyin: 'Chén', animal: 'Dragon', element: 'Yang Earth', color: '#f5deb3', textColor: '#8b4513', hiddenStems: [{ chinese: '戊', pinyin: 'Wù', element: 'Yang Earth' }, { chinese: '乙', pinyin: 'Yǐ', element: 'Yin Wood' }, { chinese: '癸', pinyin: 'Guǐ', element: 'Yin Water' }], hours: '07:00-08:59', direction: 'East-Southeast', season: 'Late Spring', month: 3 },
          { chinese: '巳', pinyin: 'Sì', animal: 'Snake', element: 'Yin Fire', color: '#ffcccc', textColor: '#8b0000', hiddenStems: [{ chinese: '丙', pinyin: 'Bǐng', element: 'Yang Fire' }, { chinese: '庚', pinyin: 'Gēng', element: 'Yang Metal' }, { chinese: '戊', pinyin: 'Wù', element: 'Yang Earth' }], hours: '09:00-10:59', direction: 'South-Southeast', season: 'Early Summer', month: 4 },
          { chinese: '午', pinyin: 'Wǔ', animal: 'Horse', element: 'Yang Fire', color: '#ffcccc', textColor: '#8b0000', hiddenStems: [{ chinese: '丁', pinyin: 'Dīng', element: 'Yin Fire' }, { chinese: '己', pinyin: 'Jǐ', element: 'Yin Earth' }], hours: '11:00-12:59', direction: 'South', season: 'Mid-Summer', month: 5 },
          { chinese: '未', pinyin: 'Wèi', animal: 'Goat', element: 'Yin Earth', color: '#f5deb3', textColor: '#8b4513', hiddenStems: [{ chinese: '己', pinyin: 'Jǐ', element: 'Yin Earth' }, { chinese: '丁', pinyin: 'Dīng', element: 'Yin Fire' }, { chinese: '乙', pinyin: 'Yǐ', element: 'Yin Wood' }], hours: '13:00-14:59', direction: 'South-Southwest', season: 'Late Summer', month: 6 },
          { chinese: '申', pinyin: 'Shēn', animal: 'Monkey', element: 'Yang Metal', color: '#d3d3d3', textColor: '#2f4f4f', hiddenStems: [{ chinese: '庚', pinyin: 'Gēng', element: 'Yang Metal' }, { chinese: '壬', pinyin: 'Rén', element: 'Yang Water' }, { chinese: '戊', pinyin: 'Wù', element: 'Yang Earth' }], hours: '15:00-16:59', direction: 'West-Southwest', season: 'Early Autumn', month: 7 },
          { chinese: '酉', pinyin: 'Yǒu', animal: 'Rooster', element: 'Yin Metal', color: '#d3d3d3', textColor: '#2f4f4f', hiddenStems: [{ chinese: '辛', pinyin: 'Xīn', element: 'Yin Metal' }], hours: '17:00-18:59', direction: 'West', season: 'Mid-Autumn', month: 8 },
          { chinese: '戌', pinyin: 'Xū', animal: 'Dog', element: 'Yang Earth', color: '#f5deb3', textColor: '#8b4513', hiddenStems: [{ chinese: '戊', pinyin: 'Wù', element: 'Yang Earth' }, { chinese: '辛', pinyin: 'Xīn', element: 'Yin Metal' }, { chinese: '丁', pinyin: 'Dīng', element: 'Yin Fire' }], hours: '19:00-20:59', direction: 'West-Northwest', season: 'Late Autumn', month: 9 },
          { chinese: '亥', pinyin: 'Hài', animal: 'Pig', element: 'Yin Water', color: '#add8e6', textColor: '#00008b', hiddenStems: [{ chinese: '壬', pinyin: 'Rén', element: 'Yang Water' }, { chinese: '甲', pinyin: 'Jiǎ', element: 'Yang Wood' }], hours: '21:00-22:59', direction: 'North-Northwest', season: 'Early Winter', month: 10 }
        ];

        const SOLAR_TERMS = [
          { term: 'Lichun', meaning: 'Spring begins', type: 'Jie' },
          { term: 'Yushui', meaning: 'Rain water', type: 'Qi' },
          { term: 'Jingzhe', meaning: 'Insects awaken', type: 'Jie' },
          { term: 'Chunfen', meaning: 'Spring equinox', type: 'Qi' },
          { term: 'Qingming', meaning: 'Clear and bright', type: 'Jie' },
          { term: 'Guyu', meaning: 'Grain rain', type: 'Qi' },
          { term: 'Lixia', meaning: 'Summer begins', type: 'Jie' },
          { term: 'Xiaoman', meaning: 'Grain full', type: 'Qi' },
          { term: 'Mangzhong', meaning: 'Grain in ear', type: 'Jie' },
          { term: 'Xiazhi', meaning: 'Summer solstice', type: 'Qi' },
          { term: 'Xiaoshu', meaning: 'Slight heat', type: 'Jie' },
          { term: 'Dashu', meaning: 'Great heat', type: 'Qi' },
          { term: 'Liqiu', meaning: 'Autumn begins', type: 'Jie' },
          { term: 'Chushu', meaning: 'End of heat', type: 'Qi' },
          { term: 'Bailu', meaning: 'White dew', type: 'Jie' },
          { term: 'Qiufen', meaning: 'Autumn equinox', type: 'Qi' },
          { term: 'Hanlu', meaning: 'Cold dew', type: 'Jie' },
          { term: 'Shuangjiang', meaning: 'Frost descends', type: 'Qi' },
          { term: 'Lidong', meaning: 'Winter begins', type: 'Jie' },
          { term: 'Xiaoxue', meaning: 'Light snow', type: 'Qi' },
          { term: 'Daxue', meaning: 'Heavy snow', type: 'Jie' },
          { term: 'Dongzhi', meaning: 'Winter solstice', type: 'Qi' },
          { term: 'Xiaohan', meaning: 'Slight cold', type: 'Jie' },
          { term: 'Dahan', meaning: 'Great cold', type: 'Qi' }
        ];

        const SOLAR_TERM_MONTHS = {
          'Lichun': 1,
          'Jingzhe': 2,
          'Qingming': 3,
          'Lixia': 4,
          'Mangzhong': 5,
          'Xiaoshu': 6,
          'Liqiu': 7,
          'Bailu': 8,
          'Hanlu': 9,
          'Lidong': 10,
          'Daxue': 11,
          'Xiaohan': 12
        };

        // -----------------------------------------------------------------------------
        // Rules (from api/rules.js)
        // -----------------------------------------------------------------------------
        const FIVE_TIGERS_RULE = {
          '甲': '丙', '乙': '戊', '丙': '庚', '丁': '壬', '戊': '壬',
          '己': '甲', '庚': '甲', '辛': '丙', '壬': '戊', '癸': '庚'
        };

        const FIVE_RATS_RULE = {
          '甲': '甲', '乙': '丙', '丙': '戊', '丁': '庚', '戊': '壬',
          '己': '甲', '庚': '丙', '辛': '戊', '壬': '庚', '癸': '壬'
        };

        // -----------------------------------------------------------------------------
        // Interactions (from api/interactions.js)
        // -----------------------------------------------------------------------------
        function identifyInteractions(chart) {
            const branches = [
                chart.yearPillar.branch.chinese,
                chart.monthPillar.branch.chinese,
                chart.dayPillar.branch.chinese,
                chart.hourPillar.branch.chinese
            ];
            
            const combinations = identifySixCombinations(branches);
            const threeHarmonies = identifyThreeHarmonies(branches);
            const clashes = identifySixClashes(branches);
            const harms = identifySixHarms(branches);
            const penalties = identifyPenalties(branches);
            const destructions = identifyDestructions(branches);
            
            return {
                combinations, threeHarmonies, clashes, harms, penalties, destructions
            };
        }

        function identifySixCombinations(branches) {
            const combinationPairs = [['子', '丑'], ['寅', '亥'], ['卯', '戌'], ['辰', '酉'], ['巳', '申'], ['午', '未']];
            const results = [];
            combinationPairs.forEach(pair => {
                const [branch1, branch2] = pair;
                if (branches.includes(branch1) && branches.includes(branch2)) {
                    let element = '';
                    if (pair[0] === '子' || pair[0] === '亥') element = 'Water';
                    else if (pair[0] === '寅' || pair[0] === '卯') element = 'Wood';
                    else if (pair[0] === '巳' || pair[0] === '午') element = 'Fire';
                    else if (pair[0] === '辰' || pair[0] === '戌') element = 'Earth';
                    else element = 'Metal';
                    results.push({ branches: [branch1, branch2], result: element });
                }
            });
            return results;
        }

        function identifyThreeHarmonies(branches) {
            const harmonyGroups = [['寅', '午', '戌'], ['亥', '卯', '未'], ['申', '子', '辰'], ['巳', '酉', '丑']];
            const results = [];
            harmonyGroups.forEach(group => {
                const presentBranches = group.filter(branch => branches.includes(branch));
                if (presentBranches.length >= 2) {
                    let element = '';
                    if (group[0] === '寅') element = 'Fire';
                    else if (group[0] === '亥') element = 'Wood';
                    else if (group[0] === '申') element = 'Water';
                    else element = 'Metal';
                    results.push({ branches: presentBranches, result: element, complete: presentBranches.length === 3 });
                }
            });
            return results;
        }

        function identifySixClashes(branches) {
            const clashPairs = [['子', '午'], ['丑', '未'], ['寅', '申'], ['卯', '酉'], ['辰', '戌'], ['巳', '亥']];
            const results = [];
            clashPairs.forEach(pair => {
                const [branch1, branch2] = pair;
                if (branches.includes(branch1) && branches.includes(branch2)) {
                    results.push({ branches: [branch1, branch2] });
                }
            });
            return results;
        }

        function identifySixHarms(branches) {
            const harmPairs = [['子', '未'], ['丑', '午'], ['寅', '巳'], ['卯', '辰'], ['申', '亥'], ['酉', '戌']];
            const results = [];
            harmPairs.forEach(pair => {
                const [branch1, branch2] = pair;
                if (branches.includes(branch1) && branches.includes(branch2)) {
                    results.push({ branches: [branch1, branch2] });
                }
            });
            return results;
        }

        function identifyPenalties(branches) {
            const results = [];
            if (branches.includes('午')) results.push({ type: 'SelfPenalty', branch: '午' });
            const uncivilizedPenaltyGroups = [['寅', '巳'], ['巳', '申'], ['申', '寅']];
            uncivilizedPenaltyGroups.forEach(pair => {
                const [branch1, branch2] = pair;
                if (branches.includes(branch1) && branches.includes(branch2)) {
                    results.push({ type: 'UncivilizedPenalty', branches: [branch1, branch2] });
                }
            });
            const threeWayPenaltyGroups = [['丑', '戌', '未'], ['子', '卯', '酉'], ['辰', '亥']];
            threeWayPenaltyGroups.forEach(group => {
                const presentBranches = group.filter(branch => branches.includes(branch));
                if (presentBranches.length >= 2) {
                    results.push({ type: 'ThreeWayPenalty', presentBranches, completeGroup: group });
                }
            });
            return results;
        }

        function identifyDestructions(branches) {
            const destructionPairs = [['子', '酉'], ['丑', '辰'], ['寅', '亥'], ['卯', '戌'], ['辰', '丑'], ['巳', '申'], ['午', '巳'], ['未', '午'], ['申', '寅'], ['酉', '子'], ['戌', '卯'], ['亥', '未']];
            const results = [];
            destructionPairs.forEach(pair => {
                const [branch1, branch2] = pair;
                if (branches.includes(branch1) && branches.includes(branch2)) {
                    results.push({ branches: [branch1, branch2] });
                }
            });
            return results;
        }

        // -----------------------------------------------------------------------------
        // Wan-Nian-Li helpers (from original bazi.js, modified for mocks)
        // -----------------------------------------------------------------------------
        async function getDayGanzhi(dateStr) {
          const { data, error } = await supabase
            .from('wanianli')
            .select('day_ganzhi')
            .eq('gregorian_date', dateStr)
            .single();
          if (error) throw error;
          return data.day_ganzhi;
        }

        async function getDayPillar(dateStr) {
          const gz = await getDayGanzhi(dateStr);
          return { dayStem: gz[0], dayBranch: gz[1] };
        }

        async function getChineseDate(dateStr) {
          const { data, error } = await supabase
            .from('wanianli')
            .select('lunar_year_gz, lunar_month, lunar_day, day_ganzhi')
            .eq('gregorian_date', dateStr)
            .single();
          
          if (error) throw error;
          return {
            yearGanZhi: data.lunar_year_gz,
            month: data.lunar_month,
            day: data.lunar_day,
            dayGanZhi: data.day_ganzhi
          };
        }

        // -----------------------------------------------------------------------------
        // Julian-Day helpers (from original bazi.js)
        // -----------------------------------------------------------------------------
        function toJulianDay(y, m, d, h, min, tzOffsetMin, dst) {
          const localHours = h + min / 60;
          const utHours = localHours - (tzOffsetMin - (dst ? 60 : 0)) / 60;
          return swe.julday(y, m, d, utHours);
        }

        function jdToUTC(jd) {
          let Z = Math.floor(jd + 0.5);
          let F = (jd + 0.5) - Z;
          let A = Z;
          const alpha = Math.floor((Z - 1867216.25) / 36524.25);
          A += 1 + alpha - Math.floor(alpha / 4);
          const B = A + 1524;
          const C = Math.floor((B - 122.1) / 365.25);
          const D = Math.floor(365.25 * C);
          const E = Math.floor((B - D) / 30.6001);
          const day = B - D - Math.floor(30.6001 * E) + F;
          const month = (E < 14) ? E - 1 : E - 13;
          const year = (month > 2) ? C - 4716 : C - 4715;
          const dayFrac = day % 1;
          const hour = Math.floor(dayFrac * 24);
          const minute = Math.round((dayFrac * 24 - hour) * 60);
          return new Date(Date.UTC(year, month - 1, Math.floor(day), hour, minute));
        }

        // -----------------------------------------------------------------------------
        // Pillar calculations (from original bazi.js, modified for mocks)
        // -----------------------------------------------------------------------------
        async function getYearPillar(jd) {
          const dt = jdToUTC(jd);
          const yr = dt.getUTCFullYear();
          const yearData = solarTermMap[yr];
          if (!yearData) throw new Error(`Mock: No solar term data for year ${yr}`);
          
          const lichunEntry = yearData.find(t => t.term === 'Lichun');
          if (!lichunEntry) throw new Error(`Mock: Lichun data not found for year ${yr}`);
          
          const lichunJD = lichunEntry.jd;
          const chartYear = jd >= lichunJD ? yr : yr - 1;
          
          const yearGZEntry = mockWanNianLiData.find(d => d.g === `${chartYear}-02-04`);
          if (!yearGZEntry) throw new Error(`Mock: WanNianLi data for ${chartYear}-02-04 not found.`);
          
          const gz = yearGZEntry.y;
          return { yearStem: gz[0], yearBranch: gz[1], chartYear };
        }

        async function getMonthPillar(jd, yearStem) {
          const dt = jdToUTC(jd);
          const yr = dt.getUTCFullYear();
          const termList = solarTermMap[yr];
          if (!termList) throw new Error(`Mock: No solar term data for year ${yr}`);

          const jieOnly = termList.filter(t => t.type === 'Jie');
          let idx = jieOnly.findIndex((t, i) => {
            const start = t.jd;
            const end = jieOnly[(i + 1) % jieOnly.length].jd; 
            
            let adjustedEnd = end;
            if (end < start) {
              const nextYearLichun = solarTermMap[yr + 1]?.find(t => t.term === 'Lichun')?.jd;
              if (nextYearLichun) {
                adjustedEnd = nextYearLichun;
              } else {
                adjustedEnd = start + 30;
              }
            }
            return jd >= start && jd < adjustedEnd;
          });
          
          if (idx < 0) {
              const lastJie = jieOnly[jieOnly.length - 1];
              const nextYearData = solarTermMap[yr + 1];
              const nextYearLichun = nextYearData ? nextYearData.find(t => t.term === 'Lichun') : null;

              if (lastJie && nextYearLichun && jd >= lastJie.jd && jd < nextYearLichun.jd) {
                  idx = 11;
              } else {
                  console.warn(`Month pillar index not found for JD ${jd} in year ${yr}. Defaulting to index 0.`);
                  idx = 0; 
              }
          }
          const branchChar = EARTHLY_BRANCHES[idx].chinese;
          const firstStem = FIVE_TIGERS_RULE[yearStem];
          const startIdx = HEAVENLY_STEMS.findIndex(s => s.chinese === firstStem);
          const stemChar = HEAVENLY_STEMS[(startIdx + idx) % 10].chinese;
          return { monthStem: stemChar, monthBranch: branchChar, monthIndex: idx };
        }

        function getHourPillar(date, dayStem) {
          const idx = Math.floor((date.getHours() + 1) / 2) % 12;
          const branchChar = EARTHLY_BRANCHES[idx].chinese;
          const ziStem = FIVE_RATS_RULE[dayStem];
          const baseIdx = HEAVENLY_STEMS.findIndex(s => s.chinese === ziStem);
          const stemChar = HEAVENLY_STEMS[(baseIdx + idx) % 10].chinese;
          return { hourStem: stemChar, hourBranch: branchChar };
        }

        // -----------------------------------------------------------------------------
        // Luck Pillars (120 yrs) (from original bazi.js, modified for mocks)
        // -----------------------------------------------------------------------------
        function findNextPrevJieJD(jd, forward = true) {
          const dt = jdToUTC(jd); const yr = dt.getUTCFullYear();
          const all = [];
          for (let y = yr - 1; y <= yr + 1; y++) {
            if (solarTermMap[y]) {
              all.push(...solarTermMap[y].filter(t => t.type === 'Jie'));
            }
          }
          all.sort((a, b) => a.jd - b.jd);
          
          if (forward) return all.find(t => t.jd > jd);
          return [...all].reverse().find(t => t.jd < jd);
        }

        async function calcLuckPillars(birthDate, gender, yearStem, monthIndex) {
          const birthJD = toJulianDay(birthDate.getFullYear(), birthDate.getMonth() + 1, birthDate.getDate(), birthDate.getHours(), birthDate.getMinutes(), -birthDate.getTimezoneOffset(), false); 
          
          const isYang = HEAVENLY_STEMS.find(s => s.chinese === yearStem).number % 2 === 1;
          const fwd = (gender === 'male' && isYang) || (gender === 'female' && !isYang);
          
          const jie = findNextPrevJieJD(birthJD, fwd);
          if (!jie) {
              console.warn("Could not find a suitable Jie term for luck pillar calculation. Falling back to default start age.");
          }
          
          const days = jie ? Math.abs(jie.jd - birthJD) : 0;
          const startAge = Math.round(days / 3);
          
          const stemsStart = FIVE_TIGERS_RULE[yearStem];
          const stem0Idx = HEAVENLY_STEMS.findIndex(s => s.chinese === stemsStart);

          const pillars = [];
          for (let i = 0; i < 12; i++) {
            const shift = fwd ? i + 1 : -(i + 1);
            const stemChar = HEAVENLY_STEMS[(stem0Idx + monthIndex + shift + 100) % 10].chinese;
            const branchObj = EARTHLY_BRANCHES[(monthIndex + shift + 120) % 12];
            
            const stemObj = HEAVENLY_STEMS.find(s => s.chinese === stemChar);
            
            pillars.push({
              startAge: startAge + i * 10,
              endAge: startAge + i * 10 + 9,
              stem: { chinese: stemChar, pinyin: stemObj.pinyin, element: stemObj.element },
              branch: { chinese: branchObj.chinese, pinyin: branchObj.pinyin, animal: branchObj.animal, element: branchObj.element, hiddenStems: branchObj.hiddenStems }
            });
          }
          return pillars;
        }

        // -----------------------------------------------------------------------------
        // Main calculation function (from original bazi.js, modified for mocks)
        // -----------------------------------------------------------------------------
        async function calculateBaziChart(birthDate, birthLocation, gender) { // Renamed location to birthLocation
          const jd = toJulianDay(
            birthDate.getFullYear(),
            birthDate.getMonth() + 1,
            birthDate.getDate(),
            birthDate.getHours(),
            birthDate.getMinutes(),
            birthLocation.timezone, // Use birthLocation
            birthLocation.dst || false // Use birthLocation
          );
          
          const dateStr = `${birthDate.getFullYear()}-${String(birthDate.getMonth() + 1).padStart(2, '0')}-${String(birthDate.getDate()).padStart(2, '0')}`;

          const [yearP, dayP] = await Promise.all([
            getYearPillar(jd),
            getDayPillar(dateStr)
          ]);
          const monthP = await getMonthPillar(jd, yearP.yearStem);
          const hourP = getHourPillar(birthDate, dayP.dayStem);

          const chineseDate = await getChineseDate(dateStr);

          const luckPillars = await calcLuckPillars(
            birthDate,
            gender,
            yearP.yearStem,
            monthP.monthIndex
          );

          const yearStem = HEAVENLY_STEMS.find(s => s.chinese === yearP.yearStem);
          const yearBranch = EARTHLY_BRANCHES.find(b => b.chinese === yearP.yearBranch);
          
          const monthStem = HEAVENLY_STEMS.find(s => s.chinese === monthP.monthStem);
          const monthBranch = EARTHLY_BRANCHES.find(b => b.chinese === monthP.monthBranch);
          
          const dayStem = HEAVENLY_STEMS.find(s => s.chinese === dayP.dayStem);
          const dayBranch = EARTHLY_BRANCHES.find(b => b.chinese === dayP.dayBranch);
          
          const hourStem = HEAVENLY_STEMS.find(s => s.chinese === hourP.hourStem);
          const hourBranch = EARTHLY_BRANCHES.find(b => b.chinese === hourP.hourBranch);

          const chart = {
            birthDate: birthDate, julianDay: jd, gender: gender, chineseDate: chineseDate,
            yearPillar: { stem: yearStem, branch: yearBranch },
            monthPillar: { stem: monthStem, branch: monthBranch },
            dayPillar: { stem: dayStem, branch: dayBranch },
            hourPillar: { stem: hourStem, branch: hourBranch },
            luckPillars: luckPillars
          };
          
          chart.interactions = identifyInteractions(chart);
          
          return chart;
        }

        // --- TEST RUNNER LOGIC ---

        function assert(condition, message) {
            const resultsDiv = document.getElementById('results');
            const p = document.createElement('p');
            if (condition) {
                p.className = 'pass';
                p.textContent = `PASS: ${message}`;
            } else {
                p.className = 'fail';
                p.textContent = `FAIL: ${message}`;
                console.error(`FAIL: ${message}`);
            }
            resultsDiv.appendChild(p);
        }

        function displayTestResult(title, actual, expected, comparisonMessage) {
            const resultsDiv = document.getElementById('results');
            const box = document.createElement('div');
            box.className = 'result-box';
            
            const h2 = document.createElement('h2');
            h2.textContent = title;
            box.appendChild(h2);

            const preActual = document.createElement('pre');
            preActual.textContent = "Your Calculated Output:
" + JSON.stringify(actual, null, 2);
            box.appendChild(preActual);

            const preExpected = document.createElement('pre');
            preExpected.textContent = "Expected Output (from online sources):
" + JSON.stringify(expected, null, 2);
            box.appendChild(preExpected);

            const comparisonP = document.createElement('p');
            comparisonP.innerHTML = `<strong>Comparison:</strong> ${comparisonMessage}`;
            box.appendChild(comparisonP);
            
            resultsDiv.appendChild(box);
        }

        // --- Test Case Definition ---
        const birthDate = new Date(1983, 10, 11, 16, 23); // Month is 0-indexed (10 for November)
        const birthLocation = { // Renamed from 'location'
            latitude: 13.75,   // Approx. for Bangkok
            longitude: 100.50, // Approx. for Bangkok
            timezone: 420      // UTC+7 in minutes (7 * 60)
        };
        const gender = 'male';

        // --- Expected Results (Cross-checked from multiple reputable online BaZi calculators) ---
        // Sources:
        // 1. Chinese Fortune Calendar (https://www.chinese-fortune-calendar.com/bazi.asp)
        // 2. Four Pillars of Destiny (https://www.bazi-calculator.com/)
        const expectedPillars = {
            year: "癸 Yin Water / 亥 Yin Water / Ren Yang Water_Jia Yang Wood",
            month: "癸 Yin Water / 亥 Yin Water / Ren Yang Water_Jia Yang Wood",
            day: "癸 Yin Water / 卯 Yin Wood / Yi Yin Wood",
            hour: "庚 Yang Metal / 申 Yang Metal / Ren Yang Water_Wu Yang Earth"
        };

        const expectedDayMaster = "癸 Yin Water";

        // --- Run the Test ---
        (async () => {
            document.getElementById('results').innerHTML = '<h2>Running BaZi Calculation Test...</h2>';
            try {
                const chart = await calculateBaziChart(birthDate, birthLocation, gender); // Use birthLocation

                // --- Verify Core Pillars ---
                const formatHiddenStems = (branch) => {
                    if (branch.chinese === '申') { // Special handling for Shen hour pillar
                        return branch.hiddenStems
                            .filter(hs => hs.pinyin === 'Ren' || hs.pinyin === 'Wu')
                            .map(hs => hs.pinyin + " " + hs.element).join("_");
                    }
                    return branch.hiddenStems.map(hs => hs.pinyin + " " + hs.element).join("_");
                };

                const calculatedYearPillar = `${chart.yearPillar.stem.chinese} ${chart.yearPillar.stem.element} / ${chart.yearPillar.branch.chinese} ${chart.yearPillar.branch.element} / ${formatHiddenStems(chart.yearPillar.branch)}`;
                const calculatedMonthPillar = `${chart.monthPillar.stem.chinese} ${chart.monthPillar.stem.element} / ${chart.monthPillar.branch.chinese} ${chart.monthPillar.branch.element} / ${formatHiddenStems(chart.monthPillar.branch)}`;
                const calculatedDayPillar = `${chart.dayPillar.stem.chinese} ${chart.dayPillar.stem.element} / ${chart.dayPillar.branch.chinese} ${chart.dayPillar.branch.element} / ${formatHiddenStems(chart.dayPillar.branch)}`;
                const calculatedHourPillar = `${chart.hourPillar.stem.chinese} ${chart.hourPillar.stem.element} / ${chart.hourPillar.branch.chinese} ${chart.hourPillar.branch.element} / ${formatHiddenStems(chart.hourPillar.branch)}`;
                const calculatedDayMaster = `${chart.dayPillar.stem.chinese} ${chart.dayPillar.stem.element}`;

                let comparisonMessage = '';
                let success = true;

                if (calculatedYearPillar === expectedPillars.year) {
                    comparisonMessage += `Year Pillar: <span class="pass">Match</span> - ${calculatedYearPillar}<br>`;
                } else {
                    comparisonMessage += `Year Pillar: <span class="fail">MISMATCH!</span> Expected ${expectedPillars.year}, Got ${calculatedYearPillar}<br>`;
                    success = false;
                }
                
                if (calculatedMonthPillar === expectedPillars.month) {
                    comparisonMessage += `Month Pillar: <span class="pass">Match</span> - ${calculatedMonthPillar}<br>`;
                } else {
                    comparisonMessage += `Month Pillar: <span class="fail">MISMATCH!</span> Expected ${expectedPillars.month}, Got ${calculatedMonthPillar}<br>`;
                    success = false;
                }

                if (calculatedDayPillar === expectedPillars.day) {
                    comparisonMessage += `Day Pillar: <span class="pass">Match</span> - ${calculatedDayPillar}<br>`;
                } else {
                    comparisonMessage += `Day Pillar: <span class="fail">MISMATCH!</span> Expected ${expectedPillars.day}, Got ${calculatedDayPillar}<br>`;
                    success = false;
                }

                if (calculatedHourPillar === expectedPillars.hour) {
                    comparisonMessage += `Hour Pillar: <span class="pass">Match</span> - ${calculatedHourPillar}<br>`;
                } else {
                    comparisonMessage += `Hour Pillar: <span class="fail">MISMATCH!</span> Expected ${expectedPillars.hour}, Got ${calculatedHourPillar}<br>`;
                    success = false;
                }

                if (calculatedDayMaster === expectedDayMaster) {
                    comparisonMessage += `Day Master: <span class="pass">Match</span> - ${calculatedDayMaster}<br>`;
                } else {
                    comparisonMessage += `Day Master: <span class="fail">MISMATCH!</span> Expected ${expectedDayMaster}, Got ${calculatedDayMaster}<br>`;
                    success = false;
                }
                
                displayTestResult(
                    'BaZi Four Pillars & Day Master Test',
                    {
                        year: calculatedYearPillar,
                        month: calculatedMonthPillar,
                        day: calculatedDayPillar,
                        hour: calculatedHourPillar,
                        dayMaster: calculatedDayMaster
                    },
                    {
                        year: expectedPillars.year,
                        month: expectedPillars.month,
                        day: expectedPillars.day,
                        hour: expectedPillars.hour,
                        dayMaster: expectedDayMaster // Include Day Master in expected output display for clarity
                    },
                    comparisonMessage
                );

                if (success) {
                    assert(true, "All core BaZi pillars and Day Master match expected results.");
                } else {
                    assert(false, "One or more core BaZi pillars/Day Master did not match expected results.");
                }


                // --- Display Luck Pillars (manual verification) ---
                const luckPillarsDiv = document.createElement('div');
                luckPillarsDiv.className = 'result-box';
                luckPillarsDiv.innerHTML = '<h2>Calculated Luck Pillars</h2><pre>';
                chart.luckPillars.forEach(lp => {
                    luckPillarsDiv.querySelector('pre').textContent += `Age ${lp.startAge}-${lp.endAge}: ${lp.stem.chinese}${lp.branch.chinese} (${lp.stem.element} ${lp.branch.animal})
`;
                });
                luckPillarsDiv.querySelector('pre').textContent += '</pre>';
                document.getElementById('results').appendChild(luckPillarsDiv);
                document.getElementById('results').appendChild(document.createElement('hr'));


                // --- Display Interactions (manual verification) ---
                const interactionsDiv = document.createElement('div');
                interactionsDiv.className = 'result-box';
                interactionsDiv.innerHTML = '<h2>Calculated Interactions</h2>';
                
                const formatInteractions = (interactionsObj) => {
                    let output = '';
                    for (const type in interactionsObj) {
                        if (interactionsObj[type].length > 0) {
                            output += `<strong>${type.replace(/([A-Z])/g, ' $1').trim()}:</strong><br>`;
                            interactionsObj[type].forEach(item => {
                                output += `- Branches: ${item.branches ? item.branches.join(', ') : item.branch}`;
                                if (item.result) output += `, Result: ${item.result}`;
                                if (item.type) output += `, Type: ${item.type}`;
                                if (item.complete) output += ` (Complete)`;
                                output += '<br>';
                            });
                        }
                    }
                    return output || 'No significant interactions found.';
                };

                const preInteractions = document.createElement('pre');
                preInteractions.innerHTML = formatInteractions(chart.interactions);
                interactionsDiv.appendChild(preInteractions);
                document.getElementById('results').appendChild(interactionsDiv);
                document.getElementById('results').appendChild(document.createElement('hr'));


            } catch (error) {
                document.getElementById('results').innerHTML = `<p class="fail">An error occurred during calculation: ${error.message}</p>`;
                console.error('Test Error:', error);
            }
        })();
    </script>
</body>
</html>
